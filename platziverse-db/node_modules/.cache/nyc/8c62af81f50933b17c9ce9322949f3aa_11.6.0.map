{"version":3,"sources":["metric_test.js"],"names":["test","require","proxyquire","sinon","agentFixtures","metricFixtures","config","logging","AgentStub","MetricStub","db","uuid","type","sandbox","uuidArgs","where","newMetric","agentId","value","metricUuidArgs","attributes","group","include","model","raw","typeUuidArgs","limit","order","beforeEach","create","hasMany","spy","belongsTo","findOne","stub","withArgs","returns","Promise","resolve","findByUuid","toJSON","findAll","all","findByAgentUuid","findByTypeUuid","setupDatabase","afterEach","restore","t","truthy","Metric","serial","metric","true","called","calledOnce","calledWith","deepEqual"],"mappings":"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","file":"metric_test.js","sourcesContent":["'use strict'\n\nconst test = require('ava')\nconst proxyquire = require('proxyquire')\nconst sinon = require('sinon')\n\nconst agentFixtures = require('./fixtures/fx_agent')\nconst metricFixtures = require('./fixtures/fx_metric')\n\nlet config = {\n  logging: function () {}\n}\n\nlet AgentStub = null\nlet MetricStub = null\n\nlet db = null\nlet uuid = 'yyy-yyy-yyy'\nlet type = 'CPU'\n\nlet sandbox = null\n\nlet uuidArgs = {\n  where: {\n    uuid\n  }\n}\n\nlet newMetric = {\n  agentId: 1,\n  type: 'CPU',\n  value: '23%'\n}\n\nlet metricUuidArgs = {\n  attributes: ['type'],\n  group: ['type'],\n  include: [{\n    attributes: [],\n    model: AgentStub,\n    where: {\n      uuid\n    }\n  }],\n  raw: true\n}\n\nlet typeUuidArgs = {\n  attributes: ['id', 'type', 'value', 'createdAt'],\n  where: {\n    type\n  },\n  limit: 20,\n  order: [['createdAt', 'DESC']],\n  include: [{\n    attributes: [],\n    model: AgentStub,\n    where: {\n      uuid\n    }\n  }],\n  raw: true\n}\n\ntest.beforeEach(async () => {\n  sandbox = sinon.sandbox.create()\n\n  AgentStub = {\n    hasMany: sandbox.spy()\n  }\n\n  MetricStub = {\n    belongsTo: sandbox.spy()\n  }\n\n  // Modelo findOne Stub\n  AgentStub.findOne = sandbox.stub()\n  AgentStub.findOne.withArgs(uuidArgs).returns(Promise.resolve(agentFixtures.findByUuid))\n\n  MetricStub.create = sandbox.stub()\n  MetricStub.create.withArgs(newMetric).returns(Promise.resolve({toJSON () {return newMetric}}))\n\n  metricUuidArgs.include[0].model = AgentStub\n  typeUuidArgs.include[0].model = AgentStub\n  \n  // Modelo findAll Stub\n  MetricStub.findAll = sandbox.stub()\n  MetricStub.findAll.withArgs().returns(Promise.resolve(metricFixtures.all))\n  MetricStub.findAll.withArgs(metricUuidArgs).returns(Promise.resolve(metricFixtures.findByAgentUuid(uuid)))\n  MetricStub.findAll.withArgs(typeUuidArgs).returns(Promise.resolve(metricFixtures.findByTypeUuid(type, uuid)))\n\n  const setupDatabase = proxyquire('../index.js', {\n    './models/agent': () => AgentStub,\n    './models/metric': () => MetricStub\n  })\n  db = await setupDatabase(config)\n})\n\ntest.afterEach(() => {\n  sandbox && sinon.sandbox.restore()\n})\n\ntest('Metric', t => {\n  t.truthy(db.Metric, 'Servicio Metric Existe')\n})\n\ntest.serial('Metric#create', async t => {\n  let metric = await db.Metric.create(uuid, newMetric)\n\n  t.true(AgentStub.findOne.called, 'Funcion findOne esta siendo llamada')\n  t.true(AgentStub.findOne.calledOnce, 'Funcion findOne esta siento llamada una vez')\n  t.true(AgentStub.findOne.calledWith(uuidArgs), 'Funcion findOne esta siento llamada con parametros')\n  t.true(MetricStub.create.called, 'Funcion create esta siendo llamada')\n  t.true(MetricStub.create.calledOnce, 'Funcion create esta siento llamada una vez')\n\n  t.deepEqual(metric, newMetric, 'La Metrica creada es perfectamente igual al que le enviÃ©')\n})\n\ntest.serial('Metric#findByAgentUuid', async t => {\n  let metric = await db.Metric.findByAgentUuid(uuid)\n\n  t.true(MetricStub.findAll.called, 'Funcion findAll esta siendo llamada')\n  t.true(MetricStub.findAll.calledOnce, 'Funcion findAll esta siendo llamada una vez')\n  t.true(MetricStub.findAll.calledWith(metricUuidArgs), 'Funcion findAll esta siendo llamada con los argumentos correctos')\n  \n  t.deepEqual(metric, metricFixtures.findByAgentUuid(uuid), 'La Metrica buscada es perfectamente igual al que devuelve')\n})\n\ntest.serial('Metric#findByTypeUuid', async t => {\n  let metric = await db.Metric.findByTypeUuid(uuid)\n\n  t.true(MetricStub.findAll.called, 'Funcion findAll esta siendo llamada')\n  t.true(MetricStub.findAll.calledOnce, 'Funcion findAll esta siendo llamada una vez')\n  t.true(MetricStub.findAll.calledWith(typeUuidArgs), 'Funcion findAll esta siendo llamada con los argumentos correctos')\n  \n  t.deepEqual(metric, metricFixtures.findByTypeUuid(type, uuid), 'La Metrica buscada es perfectamente igual al que devuelve')\n})\n"]}